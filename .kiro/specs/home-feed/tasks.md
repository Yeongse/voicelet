# Implementation Plan

## Tasks

- [x] 1. データベーススキーマ拡張
- [x] 1.1 FollowモデルとWhisperViewモデルの追加
  - Userモデルにフォロー関係（following/followers）とavatarUrlフィールドを追加
  - Followモデルを作成し、フォロワー/フォロー中の双方向リレーションを定義
  - WhisperViewモデルを作成し、視聴履歴を記録できるようにする
  - WhisperモデルにWhisperViewとのリレーションを追加
  - 適切なインデックス（followerId, followingId, userId, whisperId）を設定
  - _Requirements: 1.3, 2.1, 3.2_

- [x] 1.2 マイグレーションの実行と確認
  - Prismaマイグレーションを生成・適用
  - 既存データとの整合性を確認
  - _Requirements: 1.3, 2.1, 3.2_

- [x] 2. バックエンドAPI実装
- [x] 2.1 (P) ストーリー取得APIの実装
  - フォロー中ユーザーの最新Whisper（24時間以内）を取得するエンドポイントを作成
  - ユーザーごとにストーリーをグループ化して返却
  - 視聴済みフラグを各ストーリーに付与
  - Zodスキーマでリクエスト/レスポンスを検証
  - _Requirements: 1.1, 1.2, 1.3_

- [x] 2.2 (P) フォローフィード取得APIの実装
  - フォロー中ユーザーの全Whisperを新着順で取得するエンドポイントを作成
  - ページネーション対応（page, limit パラメータ）
  - ユーザー情報を含むレスポンス構造を設計
  - _Requirements: 2.1, 2.2, 2.3, 2.5, 2.6_

- [x] 2.3 (P) 発見欄取得APIの実装
  - フォロー外ユーザーのWhisperを新着順で取得するエンドポイントを作成
  - 自分自身の投稿は除外
  - ページネーション対応
  - _Requirements: 3.2, 3.3, 3.5_

- [x] 2.4 視聴履歴記録APIの実装
  - Whisper視聴時に履歴を記録するエンドポイントを作成
  - 重複視聴の場合は更新のみ（upsert）
  - _Requirements: 1.3_

- [x] 3. シードデータ作成
- [x] 3.1 ホーム画面確認用シーダーの実装
  - メインユーザー（デモユーザー）を作成
  - フォロー中ユーザー5名を作成し、それぞれに複数のWhisperを生成
  - 発見欄用ユーザー5名を作成し、それぞれに複数のWhisperを生成
  - フォロー関係を設定（メインユーザーが5名をフォロー）
  - 一部の視聴履歴を作成（未視聴状態の確認用）
  - 冪等性を確保（既存データをクリアして再作成）
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 3.2_

- [x] 4. Flutterモデル・サービス層実装
- [x] 4.1 (P) ホーム画面用Freezedモデルの定義
  - UserStory、StoryItem、FeedItem、DiscoverItemモデルを作成
  - JSON serialization対応
  - build_runnerでコード生成
  - _Requirements: 1.1, 2.1, 3.2_

- [x] 4.2 ホーム画面用APIサービスの実装
  - ストーリー、フィード、発見欄の各APIを呼び出すサービスを作成
  - 視聴履歴記録APIの呼び出しメソッドを追加
  - エラーハンドリングを統一
  - _Requirements: 1.1, 2.1, 3.2_

- [x] 5. Riverpod Provider実装
- [x] 5.1 ストーリーProviderの実装
  - フォロー中ユーザーのストーリーデータを取得・管理
  - 未視聴フラグの状態管理
  - リフレッシュ機能
  - _Requirements: 1.1, 1.2, 1.3_

- [x] 5.2 フィードProviderの実装
  - 無限スクロール対応のページネーション状態管理
  - 追加ページのロード機能
  - プルリフレッシュ対応
  - _Requirements: 2.1, 2.5, 2.6_

- [x] 5.3 発見欄Providerの実装
  - 発見欄コンテンツの取得・管理
  - ページネーション対応
  - リフレッシュ機能
  - _Requirements: 3.2, 3.5_

- [x] 5.4 音声再生Providerの実装
  - 音声の再生/一時停止状態管理
  - 現在再生中のWhisper情報を保持
  - 再生完了時のコールバック
  - _Requirements: 1.4, 2.4, 3.4_

- [x] 6. ホーム画面UIコンポーネント実装
- [x] 6.1 ストーリーセクションウィジェットの実装
  - 横スクロール可能なアバターリストを表示
  - 円形アバターと未視聴時のグラデーションリングを実装
  - タップでストーリー再生画面へ遷移
  - スケルトンローダー対応
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 4.1, 4.2, 4.3, 5.1_

- [x] 6.2 フィードカードウィジェットの実装
  - ユーザーアバター、ユーザー名、投稿日時、音声の長さを表示
  - 「夜のささやき」デザインシステムに沿ったスタイリング
  - タップで音声再生を開始
  - タッチフィードバックアニメーション
  - _Requirements: 2.2, 2.3, 2.4, 4.1, 4.2, 4.3, 4.6_

- [x] 6.3 発見欄カードウィジェットの実装
  - フィードカードと同様の情報表示
  - グリッドまたはカード形式のレイアウト
  - タップで音声再生画面へ遷移
  - _Requirements: 3.3, 3.4, 4.1, 4.2, 4.3_

- [x] 6.4 共通UIコンポーネントの実装
  - スケルトンローダーウィジェット
  - エラー状態表示ウィジェット（リトライボタン付き）
  - 空状態表示ウィジェット（イラストとメッセージ）
  - _Requirements: 5.1, 5.3, 5.4_

- [x] 7. ホーム画面ページ実装
- [x] 7.1 ホームページのレイアウト構築
  - ストーリーセクション、フィード/発見タブの配置
  - タブ切り替えUI（フィード/発見）
  - 適切な余白とレイアウトバランス
  - _Requirements: 1.1, 2.1, 3.1, 4.3_

- [x] 7.2 フィードタブの実装
  - 無限スクロール対応のリスト表示
  - プルリフレッシュ対応
  - 60fps以上のスムーズなスクロール
  - _Requirements: 2.1, 2.5, 2.6, 5.5_

- [x] 7.3 発見タブの実装
  - 発見欄コンテンツのリスト/グリッド表示
  - 無限スクロール対応
  - プルリフレッシュ対応
  - _Requirements: 3.2, 3.3, 3.5, 5.5_

- [x] 8. ストーリー再生画面実装
- [x] 8.1 ストーリービューアページの構築
  - 全画面表示のストーリー再生UI
  - プログレスバー表示（音声の進行状況）
  - ユーザー情報と投稿日時の表示
  - _Requirements: 1.4, 1.5, 4.1, 4.2_

- [x] 8.2 ストーリー再生制御の実装
  - 音声の再生/一時停止（タップで切り替え）
  - 左右スワイプで前後のストーリーに移動
  - 視聴完了時の自動次ストーリー遷移
  - 視聴履歴の記録
  - _Requirements: 1.4, 1.5, 4.4_

- [x] 8.3 波形アニメーションの実装
  - 音声再生中の視覚的フィードバック
  - 既存のwaveform_indicatorを活用または拡張
  - _Requirements: 4.4_

- [x] 9. ボトムナビゲーション実装
- [x] 9.1 ボトムナビゲーションウィジェットの作成
  - ホーム、検索/発見、録音、プロフィールのタブを配置
  - アクティブタブのハイライト表示
  - 新規投稿（録音）ボタンの強調デザイン
  - _Requirements: 6.1, 6.3, 6.4_

- [x] 9.2 ナビゲーション統合
  - go_routerとの連携
  - 各タブから対応画面への遷移
  - 録音画面への遷移
  - _Requirements: 6.2, 6.4_

- [x] 10. 全体統合とテスト
- [x] 10.1 ルーティング設定の更新
  - ホーム画面をメインルートとして設定
  - ストーリー再生画面のルートを追加
  - スプラッシュ画面からホーム画面への遷移を設定
  - _Requirements: 1.4, 6.2_

- [ ] 10.2 シードデータを使った動作確認
  - バックエンドでシードを実行
  - 各API（ストーリー、フィード、発見）の動作確認
  - Flutter側から実際にデータを取得・表示
  - _Requirements: 1.1, 2.1, 3.2_

- [ ] 10.3 E2E動作確認
  - ホーム画面表示の確認
  - ストーリー視聴フローの確認（タップ→再生→次ストーリー）
  - フィード/発見タブの切り替え確認
  - 無限スクロールとプルリフレッシュの動作確認
  - ボトムナビゲーションからの画面遷移確認
  - _Requirements: 1.1, 1.4, 1.5, 2.1, 2.5, 2.6, 3.1, 3.2, 6.1, 6.2_
