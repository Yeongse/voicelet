# Implementation Plan

## Task Overview
自分のストーリー閲覧機能の実装タスク。バックエンドAPI、モバイルUI、統合テストの順で進行。

---

## Tasks

- [x] 1. バックエンドAPIの実装
- [x] 1.1 (P) 閲覧者一覧取得APIの実装
  - 指定したストーリーの閲覧者一覧を取得する機能を追加
  - オーナー検証を行い、自分のストーリーのみ閲覧者情報を取得可能にする
  - 閲覧者のユーザー情報（名前、アバター）と閲覧日時を返却
  - 閲覧日時の降順でソートして返却
  - 閲覧者の総数をレスポンスに含める
  - _Requirements: 4.2, 4.3, 4.4, 6.4_

- [x] 1.2 (P) ストーリー削除APIの実装
  - 指定したストーリーを削除する機能を追加
  - オーナー検証を行い、自分のストーリーのみ削除可能にする
  - データベースからストーリーレコードを削除（閲覧履歴は自動カスケード削除）
  - ストレージサービスから音声ファイルも削除
  - 削除失敗時のエラーハンドリングを実装
  - _Requirements: 5.3, 6.5_

- [x] 1.3 閲覧記録APIの更新（Upsert対応）
  - 同一ユーザーが同一ストーリーを再度閲覧した場合、閲覧日時のみ更新する
  - 重複レコードを作成せずにupsert処理を実装
  - 既存の409エラーレスポンスから200レスポンスに変更
  - _Requirements: 6.1, 6.2, 6.3_

- [x] 2. モバイルデータ層の実装
- [x] 2.1 閲覧者データモデルの定義
  - 閲覧者情報を表すFreezedモデルを作成
  - ユーザーID、名前、アバターURL、閲覧日時を含む
  - JSON変換用のファクトリメソッドを実装
  - コード生成を実行してfreeezdファイルを生成
  - _Requirements: 4.2_

- [x] 2.2 APIサービスへのメソッド追加
  - 閲覧者一覧取得メソッドを追加
  - ストーリー削除メソッドを追加
  - エラーハンドリングを実装
  - _Requirements: 4.2, 5.3_

- [x] 2.3 Riverpodプロバイダーの実装
  - 閲覧者一覧を取得するプロバイダーを作成（whisperId別）
  - ストーリー削除処理を行うプロバイダーを作成
  - ローディング状態とエラー状態を管理
  - _Requirements: 4.2, 5.3, 5.6_

- [x] 3. 自分のストーリー再生画面の実装
- [x] 3.1 基本再生画面の作成
  - 全画面表示の再生画面を新規作成
  - 音声プレーヤーの初期化とストリーム購読を実装
  - 再生/一時停止の切り替え機能を実装
  - 再生終了時に停止状態で待機する動作を実装
  - ローディング中のインジケーター表示を実装
  - _Requirements: 2.1, 2.5, 2.6_

- [x] 3.2 シークバー機能の実装
  - 音声の再生位置を示すシークバーUIを追加
  - シークバーのドラッグ操作で再生位置を変更
  - シークバー上のタップで再生位置を変更
  - 現在の再生位置と総時間を数値で表示
  - _Requirements: 2.2, 2.3, 2.4_

- [x] 3.3 ストーリー間ナビゲーションの実装
  - 画面の右側タップで次のストーリーへ移動
  - 画面の左側タップで前のストーリーへ移動
  - 最後のストーリーで右タップ時にホームへ戻る
  - 最初のストーリーで左タップ時に先頭から再生
  - 画面上部にストーリー進捗インジケーターを表示
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 3.4 ヘッダーとメニューの実装
  - 閉じるボタンを配置
  - メニューボタンから削除オプションを表示可能にする
  - ストーリーの投稿時間を表示
  - _Requirements: 5.1_

- [x] 4. 閲覧者一覧機能の実装
- [x] 4.1 閲覧者一覧ボトムシートの作成
  - 上スワイプで表示されるボトムシートを実装
  - 閲覧者のアバター画像とユーザー名を一覧表示
  - 閲覧日時を表示
  - 閲覧者の総数をヘッダーに表示
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 4.2 閲覧者0人時の空状態表示
  - 閲覧者がいない場合のメッセージを表示
  - 適切なアイコンやイラストを配置
  - _Requirements: 4.5_

- [x] 4.3 閲覧者タップでプロフィール遷移
  - 閲覧者をタップするとプロフィール画面へ遷移
  - ボトムシートを閉じて遷移する
  - _Requirements: 4.6_

- [x] 5. 削除機能の実装
- [x] 5.1 削除確認ダイアログの作成
  - 削除前の確認ダイアログを表示
  - キャンセルボタンと確認ボタンを配置
  - 確認ボタンタップでAPI呼び出し
  - _Requirements: 5.2, 5.3_

- [x] 5.2 削除処理中のUI状態管理
  - 削除処理中はローディングインジケーターを表示
  - 処理中は他の操作を無効化
  - 削除完了後に再生画面を閉じてホームへ戻る
  - 削除後にストーリー一覧を自動更新
  - _Requirements: 5.4, 5.6_

- [x] 5.3 削除エラーハンドリング
  - 削除失敗時にエラーメッセージを表示
  - ストーリーは削除せず保持
  - リトライ可能な状態を維持
  - _Requirements: 5.5_

- [x] 6. 画面遷移とルーティングの統合
- [x] 6.1 ルーターへの画面登録
  - 自分のストーリー再生画面をルーターに追加
  - パラメータでストーリーリストと開始インデックスを受け渡し
  - _Requirements: 2.1_

- [x] 6.2 ホーム画面からの遷移接続
  - 自分のストーリーセクションのタップ時に新しい再生画面へ遷移
  - 既存のコールバック処理を更新
  - _Requirements: 1.1_

- [x] 7. 統合テストと動作確認
- [x] 7.1 バックエンドAPIのテスト
  - 閲覧者一覧APIの正常系・異常系テスト
  - 削除APIの正常系・異常系テスト
  - オーナー検証のテスト（権限エラー）
  - _Requirements: 4.2, 5.3, 6.4, 6.5_

- [ ] 7.2 E2Eテストの実施
  - ストーリー再生からシーク操作の動作確認
  - 閲覧者一覧表示の動作確認
  - 削除フローの動作確認（確認ダイアログ→削除完了）
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 4.1, 5.1, 5.2, 5.3, 5.4_
