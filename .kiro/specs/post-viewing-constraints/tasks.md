# Implementation Plan

## Tasks

- [x] 1. バックエンドAPIで視聴済み投稿を除外する
- [x] 1.1 (P) おすすめユーザー一覧APIで視聴済み投稿を除外する
  - おすすめユーザー取得時に、リクエストユーザーが視聴済みの投稿を持つユーザーを適切にフィルタリングする
  - 視聴済みWhisperを持たないユーザーのみを一覧に含める
  - 有効期限フィルタリングは既に実装済みのため維持する
  - _Requirements: 1.1, 1.2, 1.3, 3.1_

- [x] 1.2 (P) おすすめユーザーのストーリー取得APIで視聴済み投稿を除外する
  - 特定ユーザーのストーリー取得時に、視聴済み投稿を一覧から除外する
  - 有効期限フィルタリングは既に実装済みのため維持する
  - isViewedフラグは除外により不要となるため削除する
  - _Requirements: 1.1, 1.2, 1.3, 3.1_

- [x] 1.3 (P) フォロー中ユーザーのストーリー取得APIで視聴済み投稿を除外する
  - フォロー中ユーザーのストーリー取得時に、視聴済み投稿を一覧から除外する
  - ユーザーごとのグループ化ロジックを維持しつつ、視聴済み投稿を除外する
  - hasUnviewedフラグは除外により常にtrueとなるため削除を検討する
  - 有効期限フィルタリングは既に実装済みのため維持する
  - _Requirements: 1.1, 1.2, 1.3, 3.1_

- [x] 2. モバイルクライアントで再生制御を実装する
- [x] 2.1 視聴記録APIの呼び出しタイミングを変更する
  - 再生開始前に視聴記録APIを呼び出すように処理順序を変更する
  - API呼び出し成功後のみ音声再生を開始する
  - 既に視聴済み（409エラー）の場合は視聴済みメッセージを表示する
  - APIエラー時は再生を中断してエラーメッセージを表示する
  - _Requirements: 2.2, 2.3, 2.4, 3.3_

- [x] 2.2 再生中の一時停止・シーク操作を無効化する
  - 再生中は画面中央タップによる一時停止トグルを無効化する
  - 再生状態を管理して、再生中は操作を受け付けないようにする
  - シークバーは表示のみとし操作不可の状態を維持する
  - _Requirements: 2.1, 2.5_

- [x] 3. 統合テストと動作確認
- [x] 3.1 バックエンドAPIの視聴済み除外をテストする
  - 視聴記録を作成後、投稿一覧から除外されることを確認する
  - 有効期限切れ投稿が一覧に表示されないことを確認する
  - 複数ユーザーのシナリオで正しくフィルタリングされることを確認する
  - _Requirements: 1.1, 1.2, 1.3, 3.1, 3.2_

- [x] 3.2 モバイルクライアントの再生制御をテストする
  - 再生開始時に視聴記録が作成されることを確認する
  - 再生中に一時停止操作が無効であることを確認する
  - 視聴済み投稿の再生が防止されることを確認する
  - APIエラー時に適切なエラー表示と再生中断を確認する
  - _Requirements: 2.1, 2.2, 2.4, 2.5, 3.3_
