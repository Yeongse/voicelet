# Implementation Plan

## Task 1: データベーススキーマの拡張

- [x] 1.1 Userモデルに非公開フラグを追加
  - 鍵垢状態を管理するブーリアンフィールドを追加
  - デフォルト値はfalse（公開）
  - マイグレーションを作成して適用
  - _Requirements: 3.1, 3.4_

- [x] 1.2 フォローリクエストモデルを新規作成
  - リクエスト送信者と対象者のリレーションを定義
  - 同一ペアの重複を防ぐユニーク制約を設定
  - 検索用のインデックスを追加
  - マイグレーションを作成して適用
  - _Requirements: 3.2, 4.1, 4.4_

## Task 2: フォロー機能のバックエンド実装

- [x] 2.1 フォロー作成エンドポイントの拡張
  - 認証ユーザーのIDをJWTから取得するよう変更
  - 対象ユーザーの鍵垢状態を確認
  - 公開アカウントの場合はフォロー関係を即時作成
  - 鍵垢の場合はフォローリクエストを作成（202レスポンス）
  - 自己フォローと重複フォローのバリデーション
  - _Requirements: 1.1, 1.4, 3.2, 4.1, 4.4_

- [x] 2.2 (P) フォロー解除エンドポイントの改善
  - URLパラメータで対象ユーザーIDを受け取るよう変更
  - 認証ユーザーのフォロー関係のみ削除可能に
  - _Requirements: 1.3_

- [x] 2.3 (P) フォロワー削除エンドポイントの追加
  - 認証ユーザーのフォロワーを削除する機能
  - 自分のフォロワーに対してのみ許可
  - _Requirements: 6.1_

## Task 3: フォロー一覧機能のバックエンド実装

- [x] 3.1 (P) フォロー中ユーザー一覧エンドポイントの追加
  - 指定ユーザーがフォローしているユーザー一覧を返却
  - ページネーションパラメータをサポート
  - 鍵垢ユーザーの一覧は非フォロワーに403を返却
  - _Requirements: 2.1, 2.3, 2.4_

- [x] 3.2 (P) フォロワー一覧エンドポイントの追加
  - 指定ユーザーのフォロワー一覧を返却
  - ページネーションパラメータをサポート
  - 鍵垢ユーザーの一覧は非フォロワーに403を返却
  - _Requirements: 2.2, 2.3, 2.4_

## Task 4: フォローリクエスト機能のバックエンド実装

- [x] 4.1 フォローリクエスト一覧エンドポイントの追加
  - 認証ユーザー宛のリクエスト一覧を返却
  - リクエスト送信者の情報を含める
  - ページネーションをサポート
  - _Requirements: 5.1_

- [x] 4.2 (P) フォローリクエストカウントエンドポイントの追加
  - バッジ表示用の保留中リクエスト数を返却
  - _Requirements: 5.5_

- [x] 4.3 フォローリクエスト承認エンドポイントの追加
  - トランザクション内でリクエスト削除とフォロー作成を実行
  - 対象ユーザーのみ承認可能
  - _Requirements: 5.2_

- [x] 4.4 (P) フォローリクエスト拒否エンドポイントの追加
  - リクエストを削除（フォロー関係は作成しない）
  - 対象ユーザーのみ拒否可能
  - _Requirements: 5.3_

- [x] 4.5 (P) フォローリクエスト取消エンドポイントの追加
  - 送信者が自分のリクエストを取り消す機能
  - 送信者本人のみ取消可能（403チェック）
  - _Requirements: 4.3_

## Task 5: 鍵垢設定機能のバックエンド実装

- [x] 5. プロフィール更新エンドポイントに非公開設定を追加
  - 既存のプロフィール更新APIを拡張
  - 非公開フラグの更新を許可
  - _Requirements: 3.1, 3.4_

## Task 6: Mobileのフォロー状態管理の実装

- [x] 6.1 フォロー状態を表す列挙型とモデルの作成
  - フォロー状態（なし・フォロー中・リクエスト送信済み）の定義
  - フォローリクエストモデルの作成
  - _Requirements: 1.2, 4.2_

- [x] 6.2 フォロー操作用のAPIサービスの作成
  - フォロー作成・解除のAPI呼び出し
  - フォローリクエスト操作のAPI呼び出し
  - エラーハンドリング
  - _Requirements: 1.1, 1.3, 4.1, 4.3_

- [x] 6.3 フォロー状態を管理するProviderの作成
  - ユーザーごとのフォロー状態を管理
  - オプティミスティックUI更新のサポート
  - 状態の再取得メソッド
  - _Requirements: 1.2, 4.2_

## Task 7: Mobileのフォロー一覧機能の実装

- [x] 7.1 フォロー一覧を管理するProviderの作成
  - フォロー中ユーザー一覧の取得
  - フォロワー一覧の取得
  - ページネーションの管理
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 7.2 フォロー一覧画面の作成
  - フォロー中・フォロワーを切り替えるタブ
  - ユーザーカード表示
  - 無限スクロールによるページネーション
  - 鍵垢の場合の非表示メッセージ
  - _Requirements: 2.1, 2.2, 2.4_

- [x] 7.3 フォロワー削除機能の追加
  - フォロワー一覧からの削除ボタン
  - 削除前の確認ダイアログ
  - 削除成功時のメッセージと一覧更新
  - エラー時のメッセージ表示
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

## Task 8: Mobileのプロフィール画面拡張

- [x] 8.1 プロフィール画面にフォロー関連情報を追加
  - フォロー数・フォロワー数の表示
  - タップで一覧画面への遷移
  - 鍵垢ユーザーの鍵アイコン表示
  - _Requirements: 2.1, 2.2, 3.5_

- [x] 8.2 フォローボタンの実装
  - フォロー状態に応じたボタン表示（フォロー・フォロー中・リクエスト送信済み）
  - タップでフォロー操作を実行
  - エラー時のメッセージ表示
  - _Requirements: 1.1, 1.2, 1.3, 1.5, 4.1, 4.2, 4.3, 4.5_

## Task 9: Mobileのフォローリクエスト管理機能の実装

- [x] 9.1 フォローリクエスト一覧を管理するProviderの作成
  - 受信リクエスト一覧の取得
  - リクエストカウントの取得（バッジ用）
  - 承認・拒否操作
  - _Requirements: 5.1, 5.2, 5.3, 5.5_

- [x] 9.2 フォローリクエスト一覧画面の作成
  - リクエスト送信者の情報表示
  - 承認・拒否ボタンの配置
  - 操作後の一覧更新
  - _Requirements: 5.1, 5.4_

- [x] 9.3 ホーム画面へのリクエストバッジ追加
  - 保留中リクエスト数のバッジ表示
  - リクエスト一覧画面への導線
  - _Requirements: 5.5_

## Task 10: Mobileの鍵垢設定機能の実装

- [x] 10.1 プロフィール編集画面に非公開設定を追加
  - 非公開トグルスイッチ
  - 設定変更時のAPI呼び出し
  - 変更成功時のフィードバック
  - _Requirements: 3.1, 3.4_

## Task 11: 統合テスト

- [ ] 11.1 (P) バックエンドAPIの統合テスト
  - フォロー作成→一覧取得→削除のフロー
  - 鍵垢設定→リクエスト送信→承認のフロー
  - 非フォロワーによる鍵垢一覧アクセス拒否
  - _Requirements: 1.1, 1.3, 2.1, 2.2, 2.4, 3.2, 5.2_

- [ ] 11.2 (P) Mobileの画面遷移テスト
  - プロフィール画面でのフォローボタン操作
  - フォロー一覧表示と無限スクロール
  - フォローリクエスト一覧での承認・拒否操作
  - _Requirements: 1.2, 2.1, 2.2, 5.4_
