// Prisma Schema
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// User Model (テンプレート例)
// ===========================================

model User {
  id         String    @id @default(uuid())
  email      String    @unique
  name       String?
  bio        String?   @db.VarChar(500)
  birthMonth String?   @map("birth_month") @db.Char(7)  // YYYY-MM
  avatarPath String?   @map("avatar_path")
  isPrivate  Boolean   @default(false) @map("is_private")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  whispers          Whisper[]
  followers         Follow[]         @relation("following")
  following         Follow[]         @relation("follower")
  views             WhisperView[]
  sentRequests      FollowRequest[]  @relation("requester")
  receivedRequests  FollowRequest[]  @relation("target")

  @@map("users")
}

// ===========================================
// Whisper Model (音声投稿)
// ===========================================

model Whisper {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  bucketName String   @map("bucket_name")
  fileName   String   @map("file_name")
  duration   Int      // 秒数
  createdAt  DateTime @default(now()) @map("created_at")
  expiresAt  DateTime @map("expires_at")

  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  views      WhisperView[]

  @@index([userId])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("whispers")
}

// ===========================================
// Follow Model (フォロー関係)
// ===========================================

model Follow {
  id          String   @id @default(uuid())
  followerId  String   @map("follower_id")
  followingId String   @map("following_id")
  createdAt   DateTime @default(now()) @map("created_at")

  follower    User     @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

// ===========================================
// WhisperView Model (視聴履歴)
// ===========================================

model WhisperView {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  whisperId String   @map("whisper_id")
  viewedAt  DateTime @default(now()) @map("viewed_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  whisper   Whisper  @relation(fields: [whisperId], references: [id], onDelete: Cascade)

  @@unique([userId, whisperId])
  @@index([userId])
  @@index([whisperId])
  @@map("whisper_views")
}

// ===========================================
// FollowRequest Model (フォローリクエスト)
// ===========================================

model FollowRequest {
  id          String   @id @default(uuid())
  requesterId String   @map("requester_id")
  targetId    String   @map("target_id")
  createdAt   DateTime @default(now()) @map("created_at")

  requester   User     @relation("requester", fields: [requesterId], references: [id], onDelete: Cascade)
  target      User     @relation("target", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([requesterId, targetId])
  @@index([requesterId])
  @@index([targetId])
  @@map("follow_requests")
}
