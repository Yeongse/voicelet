# Implementation Plan: QRコードフォロー機能

## Tasks

- [x] 1. 環境セットアップとプラットフォーム設定
- [x] 1.1 依存パッケージの追加
  - pubspec.yamlにqr_flutter 4.1.0とmobile_scanner 7.1.4を追加
  - flutter pub getで依存関係を解決
  - _Requirements: 1.1, 1.2, 2.1_

- [x] 1.2 iOSカメラ権限設定
  - Info.plistにNSCameraUsageDescriptionを追加
  - カメラ使用理由の説明文を設定
  - _Requirements: 2.3_

- [x] 1.3 Androidカメラ権限設定
  - AndroidManifest.xmlにCAMERA権限を追加
  - カメラ機能をオプショナルとして設定
  - _Requirements: 2.3_

- [x] 2. QRコード表示機能の実装
- [x] 2.1 (P) QRコード表示ウィジェットの作成
  - 現在のユーザーIDを取得してQRコードを生成
  - voicelet://user/{userId}形式でデータを埋め込み
  - QRコードを画面中央に適切なサイズで表示
  - アプリのテーマに合わせた背景色を適用
  - _Requirements: 1.1, 1.2, 1.4_

- [x] 2.2 (P) プロフィール情報表示の追加
  - QRコード上部にユーザーのアバター画像を表示
  - ユーザー名と表示名を表示
  - オフライン状態でもローカルキャッシュから表示可能に
  - _Requirements: 1.3, 1.4_

- [x] 3. QRコードスキャン機能の実装
- [x] 3.1 (P) カメラスキャナーウィジェットの作成
  - カメラを起動してQRコードスキャンモードを開始
  - スキャン結果をリアルタイムで検出
  - カメラ権限がない場合はOSの権限ダイアログを表示
  - _Requirements: 2.1, 2.3_

- [x] 3.2 QRコード検証ロジックの実装
  - スキャン結果がvoicelet://user/プレフィックスを持つか検証
  - 有効なQRコードからuserIdを抽出
  - 無効なQRコードの場合はエラーメッセージを表示
  - _Requirements: 2.4_

- [x] 3.3 スキャン後の画面遷移処理
  - 有効なuserIdの場合、そのユーザーのプロフィール画面に遷移
  - 自分自身のQRコードをスキャンした場合は自分のプロフィール画面に遷移
  - 重複スキャンを防止するため遷移後はスキャナーを一時停止
  - _Requirements: 2.2, 2.6_

- [x] 3.4 オフライン状態のハンドリング
  - スキャン成功後、画面遷移前にネットワーク状態を確認
  - オフラインの場合は警告メッセージを表示
  - ユーザーが存在しない場合のエラーは遷移先の既存処理で対応
  - _Requirements: 4.1, 4.2, 2.5_

- [x] 4. QRコード画面の統合
- [x] 4.1 タブ切り替え画面の作成
  - 「自分のQRコード」と「スキャン」の2つのタブを持つ画面を作成
  - 初期表示は「自分のQRコード」タブ
  - タブ切り替えでQR表示とスキャナーを切り替え
  - _Requirements: 3.2_

- [x] 4.2 ナビゲーションとAppBarの設定
  - AppBarに戻るボタンを配置
  - 戻るボタンで前の画面に戻れるように設定
  - _Requirements: 3.3_

- [x] 4.3 ルーティング設定
  - /qr-codeルートを追加
  - QRコード画面への遷移を可能に
  - _Requirements: 3.1, 3.2_

- [x] 5. エントリーポイントの追加
- [x] 5.1 プロフィール画面にQRアイコンを追加
  - プロフィール画面のAppBarにQRコードアイコンを追加
  - アイコンタップでQRコード画面に遷移
  - 既存の編集・ログアウトアイコンと並列配置
  - _Requirements: 3.1_

- [x] 6. テスト
- [x] 6.1 (P) QRデータ検証ロジックのユニットテスト
  - 有効なvoicelet://user/形式の検証テスト
  - 無効なQRデータの拒否テスト
  - userId抽出ロジックのテスト
  - _Requirements: 1.2, 2.4_

- [x]* 6.2 (P) ウィジェットテスト
  - QRコード表示ウィジェットの描画テスト
  - タブ切り替え動作のテスト
  - _Requirements: 1.1, 3.2_

- [x]* 6.3 統合テスト
  - プロフィール画面からQR画面への遷移テスト
  - スキャン後のプロフィール画面遷移テスト
  - _Requirements: 2.2, 3.1_

## Requirements Coverage

| Requirement ID | Task(s) |
|----------------|---------|
| 1.1 | 2.1, 6.2 |
| 1.2 | 1.1, 2.1, 6.1 |
| 1.3 | 2.2 |
| 1.4 | 2.1, 2.2 |
| 2.1 | 1.1, 3.1 |
| 2.2 | 3.3, 6.3 |
| 2.3 | 1.2, 1.3, 3.1 |
| 2.4 | 3.2, 6.1 |
| 2.5 | 3.4 |
| 2.6 | 3.3 |
| 3.1 | 4.3, 5.1, 6.3 |
| 3.2 | 4.1, 6.2 |
| 3.3 | 4.2 |
| 4.1 | 3.4 |
| 4.2 | 3.4 |
