# Implementation Plan

## Tasks

- [x] 1. データベーススキーマ拡張
- [x] 1.1 Userモデルにプロフィールフィールドを追加
  - bio（自己紹介）フィールドを追加（最大500文字）
  - birthMonth（生年月）フィールドを追加（YYYY-MM形式、7文字固定）
  - 既存のavatarUrlをavatarPathにリネーム（Cloud Storageパス用）
  - nameフィールドをnullable に変更
  - マイグレーションファイルを生成して実行
  - _Requirements: 2.4, 9.1_

- [x] 2. バックエンド認証基盤
- [x] 2.1 JWT認証ミドルウェアを実装
  - Supabase JWT Secretを使用したトークン検証
  - Authorizationヘッダーからのトークン抽出
  - デコードされたユーザー情報（sub, email）をリクエストに付与
  - 無効なトークンに対する401エラーレスポンス
  - _Requirements: 8.1_

- [x] 2.2 認証コールバックAPIを実装
  - POST /api/auth/callback エンドポイント作成
  - アクセストークンを受け取りSupabaseユーザー情報を取得
  - Supabase UIDでローカルDBにユーザーをupsert
  - 初回認証時に空のプロフィールレコードを自動作成
  - プロフィール情報をレスポンスとして返却
  - 重複メールアドレスのエラーハンドリング
  - _Requirements: 1.1, 1.2, 1.4, 1.5, 2.1, 2.3_

- [x] 3. プロフィールCRUD API
- [x] 3.1 自分のプロフィール取得APIを実装
  - GET /api/profiles/me エンドポイント作成
  - JWT認証ミドルウェアを適用
  - 生年月から年齢を計算してレスポンスに含める
  - 年齢計算ロジック（現在月が生年月より前なら1歳減算）
  - avatarPathがあれば署名付きダウンロードURLを生成
  - birthMonthを含めた完全なプロフィール情報を返却
  - _Requirements: 3.1, 3.3, 3.4, 7.1, 7.3, 9.2, 9.3, 9.6_

- [x] 3.2 (P) 他ユーザーのプロフィール取得APIを実装
  - GET /api/profiles/:userId エンドポイント作成
  - 対象ユーザーの公開プロフィール情報を返却
  - birthMonthは含めず、計算された年齢のみを返却
  - avatarPathがあれば署名付きダウンロードURLを生成
  - 存在しないユーザーに対する404エラー
  - _Requirements: 3.2, 3.3, 3.6, 7.1, 9.2_

- [x] 3.3 プロフィール更新APIを実装
  - PATCH /api/profiles/me エンドポイント作成
  - 表示名、自己紹介、生年月、アバターパスの部分更新
  - 生年月のバリデーション（YYYY-MM形式、将来日付不可）
  - 表示名は1-100文字、自己紹介は0-500文字の制限
  - 不正データに対するバリデーションエラー（400）
  - 自分以外のプロフィール編集を禁止（403）
  - _Requirements: 4.1, 4.4, 4.5, 8.2, 8.4_

- [x] 3.4 アカウント削除APIを実装
  - DELETE /api/profiles/me エンドポイント作成
  - プロフィールレコードをデータベースから削除
  - 関連するアバター画像をCloud Storageから削除
  - Supabase Authアカウントの削除処理
  - 自分以外のアカウント削除を禁止
  - _Requirements: 5.2, 5.3, 5.4_

- [x] 4. アバター画像管理API
- [x] 4.1 アバターアップロードURL生成APIを実装
  - POST /api/profiles/me/avatar/upload-url エンドポイント作成
  - ファイル形式の検証（JPEG, PNG, WebPのみ許可）
  - ファイルサイズの検証（5MB以下）
  - ユーザーIDとタイムスタンプでパスを生成
  - 署名付きアップロードURLを生成して返却
  - 不正なファイル形式・サイズに対するエラー
  - _Requirements: 6.1, 6.4, 6.5, 6.6, 8.3_

- [x] 4.2 (P) StorageServiceにアバター用関数を追加
  - 既存のstorage.tsを拡張
  - アバター用署名付きアップロードURL生成関数
  - アバター用署名付きダウンロードURL生成関数（有効期限60分）
  - ユーザーのアバターファイル一括削除関数
  - ファイルパス命名規則の実装（avatars/{userId}/{timestamp}.{ext}）
  - _Requirements: 6.1, 7.1, 7.3, 5.3_

- [x] 5. モバイル認証機能
- [x] 5.1 Supabase Flutter SDKを設定
  - supabase_flutterパッケージの追加
  - Supabase URLとAnon Keyの環境設定
  - アプリ起動時のSupabase初期化
  - _Requirements: 1.1_

- [x] 5.2 認証状態管理Providerを実装
  - 既存のauth_provider.dartをSupabase Auth対応に置き換え
  - サインアップ/サインイン/サインアウト操作
  - onAuthStateChangeによる認証状態監視
  - 認証成功時にバックエンドAPIへコールバック
  - エラーハンドリング（無効認証情報、重複メール）
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 5.3 (P) ログイン・登録画面を実装
  - メールアドレスとパスワードの入力フォーム
  - 新規登録とログインの切り替え
  - バリデーションとエラーメッセージ表示
  - 認証成功後のホーム画面遷移
  - _Requirements: 1.1, 1.2, 1.4, 1.5, 2.5_

- [x] 6. モバイルプロフィール機能
- [x] 6.1 ProfileモデルとProviderを実装
  - Freezedを使用したProfileモデル定義
  - 自分のプロフィール取得Provider
  - 他ユーザーのプロフィール取得Provider
  - プロフィール更新用Notifier
  - _Requirements: 3.1, 3.2, 4.2_

- [x] 6.2 プロフィール表示画面を実装
  - 表示名、自己紹介、年齢の表示
  - アバター画像の表示（署名付きURLから取得）
  - アバター未設定時のデフォルト画像表示
  - 他ユーザープロフィールへの対応
  - 生年月は表示せず年齢のみ表示
  - _Requirements: 3.1, 3.2, 3.3, 3.5, 7.2, 7.4, 9.5_

- [x] 6.3 プロフィール編集画面を実装
  - 表示名、自己紹介の入力フォーム
  - 生年月入力（年・月のドロップダウンセレクター）
  - 現在の値をフォームに初期表示
  - 入力バリデーションとエラー表示
  - 保存ボタンによる更新処理
  - _Requirements: 4.1, 4.2, 4.3, 9.4_

- [x] 6.4 アバター画像アップロード機能を実装
  - 画像選択（カメラ/ギャラリー）
  - ファイル形式・サイズの事前チェック
  - 署名付きURLの取得とCloud Storageへの直接アップロード
  - アップロード完了後のプロフィール更新
  - アップロード中のプログレス表示
  - _Requirements: 6.2, 6.3, 6.4, 6.5, 6.6_

- [x] 6.5 (P) アカウント削除機能を実装
  - 削除確認ダイアログの表示
  - 削除処理とSupabaseサインアウト
  - 削除完了後のログイン画面遷移
  - _Requirements: 5.1, 5.2_

- [x] 7. 統合とセキュリティ検証
- [x] 7.1 APIクライアントに認証ヘッダーを追加
  - DioインターセプターでJWTトークンを自動付与
  - トークン期限切れ時の再認証フロー
  - 401エラー時のログイン画面遷移
  - _Requirements: 8.1_

- [x] 7.2 入力バリデーションの統合テスト
  - 各エンドポイントのバリデーションルール確認
  - XSS/SQLインジェクション防止の検証
  - エラーレスポンス形式の一貫性確認
  - _Requirements: 8.4, 8.5_

- [x] 7.3 (P) 認可ルールの統合テスト
  - 他ユーザープロフィール編集の拒否確認
  - 他ユーザーアカウント削除の拒否確認
  - 署名付きURLのユーザー固有性確認
  - _Requirements: 4.4, 5.4, 8.2, 8.3_

- [x] 7.4 E2Eフロー検証
  - 新規登録→プロフィール作成→更新の一連フロー
  - アバター画像アップロード→表示の確認
  - ログアウト→再ログインフロー
  - アカウント削除フロー
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2, 4.1, 5.2, 6.2, 6.3_
